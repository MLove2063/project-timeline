<!DOCTYPE html>
<html>
<head>
    <title>GCERC Award Timeline with Filtering</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
        }
        .bar {
            fill-opacity: 0.8;
        }
        .bar:hover {
            fill-opacity: 1;
        }
        .axis text {
            font-size: 16px;
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
        .grid line {
            stroke: lightgrey;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }
        .grid path {
            stroke-width: 0;
        }
        .legend-box {
            fill: white;
            stroke: #ccc;
            stroke-width: 1px;
            rx: 5;
            ry: 5;
        }
        .legend-title {
            font-size: 18px;
            font-weight: bold;
        }
        .legend-subtitle {
            font-size: 16px;
            font-weight: bold;
            fill: #666;
        }
        .legend-text {
            font-size: 14px;
        }
        .legend-total {
            font-size: 14px;
            font-weight: bold;
            fill: #444;
        }
        .grand-total {
            font-size: 16px;
            font-weight: bold;
            margin-top: 15px;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .today-line {
            stroke: red;
            stroke-width: 2;
            stroke-dasharray: 5,5;
        }
        .today-date {
            fill: red;
            font-size: 14px;
            font-weight: bold;
        }
        .filter-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filter-select {
            margin-right: 20px;
            font-size: 14px;
            padding: 8px;
            min-width: 200px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #timeline {
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .graph-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="filter-controls">
        <select id="grantLeadFilter" class="filter-select">
            <option value="">All Grant Leads</option>
        </select>
        <select id="programStaffFilter" class="filter-select">
            <option value="">All Program Staff</option>
        </select>
    </div>
    <div class="graph-title">GCERC Award Timeline</div>
    <div id="timeline"></div>
    <div id="debug"></div>
    <script>
        // Process data first
        const today = new Date();

        // Load data from JSON file
        d3.json("project_data.json")
            .then(function(jsonData) {
                console.log("Number of projects loaded:", jsonData.length);
                
                const data = jsonData.map(d => {
                    const startDate = new Date(d['Project Start Date']);
                    const endDate = new Date(d['Project End Date']);
                    return {
                        ...d,
                        startDate: startDate,
                        endDate: endDate,
                        status: endDate < today ? 'Closed' : 'Active',
                        color: endDate < today ? 'grey' : 'rgb(30, 144, 255)'
                    };
                })
                .filter(d => !isNaN(d.startDate) && !isNaN(d.endDate))
                .sort((a, b) => b.endDate - a.endDate);  // Sort by end date descending

                console.log("Number of valid projects:", data.length);

                // Populate dropdown menus
                const grantLeads = [...new Set(data.map(d => d['Grant Lead']).filter(Boolean))].sort();
                const programStaff = [...new Set(data.map(d => d['Programs Staff Lead']).filter(Boolean))].sort();

                const grantLeadSelect = d3.select("#grantLeadFilter");
                const programStaffSelect = d3.select("#programStaffFilter");

                grantLeads.forEach(lead => {
                    grantLeadSelect.append("option")
                        .attr("value", lead)
                        .text(lead);
                });

                programStaff.forEach(staff => {
                    programStaffSelect.append("option")
                        .attr("value", staff)
                        .text(staff);
                });

                // Set up dimensions
                const margin = {top: 150, right: 100, bottom: 50, left: 250};
                const width = 1920 - margin.left - margin.right;
                const barHeight = 15;
                const height = Math.max(400, data.length * barHeight);

                // Create SVG
                const svg = d3.select("#timeline")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                // Set up scales
                const x = d3.scaleTime()
                    .domain([d3.min(data, d => d.startDate), d3.max(data, d => d.endDate)])
                    .range([0, width]);

                const y = d3.scaleBand()
                    .domain(data.map(d => d.FAIN))
                    .range([0, height])
                    .padding(0.2);

                // Function to update the visualization
                function updateVisualization(filteredData) {
                    // Update y-scale domain with filtered data
                    y.domain(filteredData.map(d => d.FAIN));

                    // Update height
                    const newHeight = Math.max(400, filteredData.length * barHeight);
                    d3.select("#timeline svg")
                        .attr("height", newHeight + margin.top + margin.bottom);

                    // Update y-scale range
                    y.range([0, newHeight]);

                    // Update bars
                    const bars = svg.selectAll(".bar")
                        .data(filteredData, d => d.FAIN);

                    // Remove old bars
                    bars.exit().remove();

                    // Add new bars
                    bars.enter()
                        .append("rect")
                        .attr("class", "bar")
                        .merge(bars)
                        .attr("x", d => x(d.startDate))
                        .attr("y", d => y(d.FAIN))
                        .attr("width", d => Math.max(1, x(d.endDate) - x(d.startDate)))
                        .attr("height", y.bandwidth())
                        .attr("fill", d => d.color);

                    // Update axes
                    svg.selectAll(".axis").remove();

                    // Add x-axis
                    svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", `translate(0,${newHeight})`)
                        .call(d3.axisBottom(x)
                            .ticks(d3.timeYear.every(1))
                            .tickFormat(d3.timeFormat("%Y")));

                    // Add y-axis
                    svg.append("g")
                        .attr("class", "axis")
                        .call(d3.axisLeft(y));

                    // Add grid lines
                    svg.append("g")
                        .attr("class", "grid")
                        .attr("transform", `translate(0,${newHeight})`)
                        .call(d3.axisBottom(x)
                            .ticks(d3.timeYear.every(1))
                            .tickSize(-newHeight)
                            .tickFormat(""));

                    // Add today line and date
                    svg.selectAll(".today-line, .today-date").remove();
                    svg.append("line")
                        .attr("class", "today-line")
                        .attr("x1", x(today))
                        .attr("x2", x(today))
                        .attr("y1", 0)
                        .attr("y2", newHeight);
                    
                    svg.append("text")
                        .attr("class", "today-date")
                        .attr("x", x(today))
                        .attr("y", -5)
                        .attr("text-anchor", "middle")
                        .text(d3.timeFormat("%Y-%m-%d")(today));

                    // Calculate award totals
                    const closedTotal = filteredData
                        .filter(d => d.status === 'Closed')
                        .reduce((sum, d) => sum + (Number(d['Award Amount']) || 0), 0);
                    
                    const activeTotal = filteredData
                        .filter(d => d.status === 'Active')
                        .reduce((sum, d) => sum + (Number(d['Award Amount']) || 0), 0);

                    // Update legend with improved styling
                    svg.selectAll(".legend").remove();
                    
                    const legend = svg.append("g")
                        .attr("class", "legend")
                        .attr("transform", `translate(${-margin.left + 20}, -140)`);

                    // Add legend background
                    const legendPadding = 15;
                    const legendWidth = 480;
                    const legendHeight = 120;
                    
                    legend.append("rect")
                        .attr("class", "legend-box")
                        .attr("x", 0)
                        .attr("y", 0)
                        .attr("width", legendWidth)
                        .attr("height", legendHeight);

                    // Calculate grand total
                    const grandTotal = closedTotal + activeTotal;

                    // Add main title with grand total
                    legend.append("text")
                        .attr("class", "legend-title")
                        .attr("x", legendPadding)
                        .attr("y", legendPadding + 15)
                        .text("All Awards: ");

                    legend.append("text")
                        .attr("class", "legend-subtitle")
                        .attr("x", legendPadding + 120)
                        .attr("y", legendPadding + 15)
                        .style("font-size", "18px")
                        .text(`$${grandTotal.toLocaleString()}`);

                    const statuses = ['Closed', 'Active'];
                    const colors = ['grey', 'rgb(30, 144, 255)'];
                    const totals = [closedTotal, activeTotal];

                    statuses.forEach((status, i) => {
                        const legendRow = legend.append("g")
                            .attr("transform", `translate(${legendPadding}, ${legendPadding + 35 + (i * 30)})`);

                        // Add color box
                        legendRow.append("rect")
                            .attr("width", 16)
                            .attr("height", 16)
                            .attr("fill", colors[i]);

                        // Add status label
                        legendRow.append("text")
                            .attr("class", "legend-text")
                            .attr("x", 24)
                            .attr("y", 12)
                            .text(status + " Awards:");

                        // Add total amount with increased spacing
                        legendRow.append("text")
                            .attr("class", "legend-total")
                            .attr("x", 24)
                            .attr("y", 12)
                            .attr("dx", "120")
                            .text(`$${totals[i].toLocaleString()}`);
                    });

                    // Update tooltips
                    svg.selectAll(".bar")
                        .on("mouseover", function(event, d) {
                            const tooltip = d3.select("body")
                                .append("div")
                                .attr("class", "tooltip")
                                .style("opacity", 0);

                            tooltip.transition()
                                .duration(200)
                                .style("opacity", .9);
                            tooltip.html(`<b>${d.Title}</b><br>
                                        FAIN: ${d.FAIN}<br>
                                        Duration: ${d3.timeFormat("%Y-%m-%d")(d.startDate)} to ${d3.timeFormat("%Y-%m-%d")(d.endDate)}<br>
                                        Award Amount: $${d['Award Amount']?.toLocaleString() || 'N/A'}<br>
                                        Grant Lead: ${d['Grant Lead'] || 'N/A'}<br>
                                        Program Staff: ${d['Programs Staff Lead'] || 'N/A'}`)
                                .style("left", (event.pageX + 10) + "px")
                                .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", function() {
                            d3.selectAll(".tooltip").remove();
                        });
                }

                // Initial visualization with all data
                updateVisualization(data);

                // Add filter event listeners
                d3.select("#grantLeadFilter").on("change", updateFilters);
                d3.select("#programStaffFilter").on("change", updateFilters);

                function updateFilters() {
                    const selectedGrantLead = d3.select("#grantLeadFilter").property("value");
                    const selectedProgramStaff = d3.select("#programStaffFilter").property("value");

                    let filteredData = data;

                    if (selectedGrantLead) {
                        filteredData = filteredData.filter(d => d['Grant Lead'] === selectedGrantLead);
                    }
                    if (selectedProgramStaff) {
                        filteredData = filteredData.filter(d => d['Programs Staff Lead'] === selectedProgramStaff);
                    }

                    updateVisualization(filteredData);
                }

                log(`Loaded ${data.length} projects`);
            })
            .catch(function(error) {
                console.error("Error loading the data:", error);
            });
    </script>
</body>
</html> 
